<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flight Order Assistant</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Flight Orders">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    <meta name="color-scheme" content="light dark">
    <link rel="apple-touch-icon" href="https://i.imghippo.com/files/HOC2025cUU.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body {
            height: 100%; /* Ensure html and body take full viewport height */
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .seat {
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        /* Dark mode styles for ordered and delivered seats */
        .seat.ordered {
            background-color: #EF4444; /* Red 500 */
            color: white;
            border-color: #DC2626; /* Red 600 */
        }
        .dark .seat.ordered {
            background-color: #B91C1C; /* Darker Red for dark mode */
            border-color: #991B1B; /* Even darker red for dark mode border */
        }
        .seat.delivered {
            background-color: #22C55E; /* Green 500 */
            color: white;
            border-color: #16A34A; /* Green 600 */
        }
        .dark .seat.delivered {
            background-color: #15803D; /* Darker Green for dark mode */
            border-color: #14532D; /* Even darker green for dark mode border */
        }
        #modal-backdrop, #confirm-modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #order-modal, #confirm-modal {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .category-btn.active {
            background-color: #3B82F6;
            color: white;
        }
        .dark .category-btn.active {
            background-color: #2563EB;
        }
        .item-btn.selected, .modifier-btn.selected, .mixer-btn.selected {
            background-color: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
            font-weight: 600;
        }
        .dark .item-btn.selected, .dark .modifier-btn.selected, .dark .mixer-btn.selected {
            background-color: #064E3B;
            border-color: #34D399;
            color: #D1FAE5;
        }
        /* Custom radius for iPhone-like bottom corners */
        .rounded-iphone-bottom {
            border-bottom-left-radius: 35px;
            border-bottom-right-radius: 35px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">

    <div id="app-container" class="container mx-auto p-2 sm:p-4 md:p-8 flex-1 flex flex-col">
        <!-- Aircraft Selection Toggle -->
        <div class="flex justify-center space-x-2 mb-2 mt-4">
            <button id="a350-toggle" class="px-3 py-1 rounded-lg font-semibold bg-blue-500 text-white dark:bg-blue-700 dark:hover:bg-blue-600 hover:bg-blue-600 text-sm">Airbus A350</button>
            <button id="b777-toggle" class="px-3 py-1 rounded-lg font-semibold bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">Boeing 777-300</button>
        </div>

        <!-- Class Selection Toggle (for A350 only) -->
        <div id="class-selection-container" class="flex justify-center space-x-2 mb-4">
            <button id="premium-economy-toggle" class="px-3 py-1 rounded-lg font-semibold bg-blue-500 text-white dark:bg-blue-700 dark:hover:bg-blue-600 hover:bg-blue-600 text-sm">Premium Economy</button>
            <button id="economy-toggle" class="px-3 py-1 rounded-lg font-semibold bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm">Economy</button>
        </div>

        <div class="flex justify-center items-center space-x-2 sm:space-x-4 mb-6 sm:mb-8 text-xs sm:text-sm">
            <div class="flex items-center"><div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-white border-2 border-blue-500 dark:bg-gray-700"></div><span class="ml-1 sm:ml-2">Available</span></div>
            <div class="flex items-center"><div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-red-500 mr-1 sm:mr-2"></div>Ordered</div>
            <div class="flex items-center"><div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-green-500 mr-1 sm:mr-2"></div>Delivered</div>
        </div>

        <main class="flex flex-col lg:grid lg:grid-cols-3 gap-8 flex-1 overflow-hidden">
            <!-- Cabin Layout: Changed overflow-x-auto to overflow-x-hidden -->
            <div id="cabin-layout" class="lg:col-span-2 bg-white dark:bg-gray-800 p-2 sm:p-6 rounded-xl shadow-lg overflow-x-hidden overflow-y-auto max-h-[33vh]">
                <div class="flex flex-col items-center space-y-2 sm:space-y-4 w-full"> 
                </div>
            </div>

            <div id="orders-summary" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-t-xl rounded-iphone-bottom shadow-lg flex flex-col flex-grow h-0">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Orders Summary</h2>
                    <button id="clear-all-btn" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Clear All</button>
                </div>
                <div id="orders-list" class="space-y-3 overflow-y-auto flex-1 min-h-0">
                    <p class="text-gray-500 dark:text-gray-400 italic">No orders yet.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div id="order-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg flex flex-col transform scale-95 opacity-0 max-h-[85vh]">
            <div class="flex-shrink-0 p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 id="order-modal-title" class="text-2xl font-bold">Order</h2>
                    <button id="cancel-btn-x" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4 sm:p-6">
                <form id="order-form" class="space-y-6">
                    <input type="hidden" id="seat-id-input">
                    
                    <!-- Customer Name Input -->
                    <div>
                        <label for="customer-name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"><i class="fa-solid fa-user mr-2"></i>Customer Name</label>
                        <input type="text" id="customer-name-input" placeholder="Enter customer's name" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2"><i class="fa-solid fa-utensils mr-2"></i>Food</h3>
                        <div id="food-selection-container" class="flex flex-wrap gap-2">
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-3"><i class="fa-solid fa-martini-glass mr-2"></i>Drink</h3>
                        <div id="drink-category-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                        <div id="drink-accordion-container"></div>
                    </div >
                </form>
            </div>

            <div class="flex-shrink-0 p-4 sm:p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-b-xl">
                <div id="modal-summary" class="p-3 mb-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="font-semibold text-gray-700 dark:text-gray-200">Current Selection:</h4>
                    <p id="summary-text" class="text-sm text-gray-600 dark:text-gray-300 mt-1 italic">Make a selection...</p>
                </div>
                <div class="flex justify-between items-center">
                    <button type="button" id="delete-order-btn" class="text-red-600 hover:text-red-800 dark:text-red-500 dark:hover:text-red-400 font-medium">Delete Order</button>
                    <div>
                        <button type="button" id="close-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="confirm-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transform scale-95 opacity-0">
            <h3 id="confirm-modal-title" class="text-lg font-bold">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button id="confirm-action-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const FOOD_MENU = {
            'Chicken': 'fa-solid fa-drumstick-bite',
            'Beef': 'fa-solid fa-cow',
            'Fish': 'fa-solid fa-fish', // Added Fish option
            'Vegetarian': 'fa-solid fa-leaf' // Added Vegetarian option
        };

        const DRINK_MENU = {
            "Soft Drinks": { icon: "fa-solid fa-bottle-water", items: ["Pepsi", "Diet Pepsi", "Seven Up", "Diet Seven Up", "Tonic Water", "Sparkling Water", "Water"], modifiers: { 'ice': 'fa-solid fa-snowflake', 'lemon': 'fa-solid fa-lemon' } },
            "Hot Drinks": { icon: "fa-solid fa-mug-hot", items: ["Black Tea", "Green Tea", "Coffee"], modifiers: { 'milk': 'fa-solid fa-fill-drip', 'sugar': 'fa-solid fa-cube' } },
            "Wines": { icon: "fa-solid fa-wine-glass", items: ["Red Wine", "White Wine", "Sparkling Wine"], modifiers: {} },
            "Spirits": { icon: "fa-solid fa-whiskey-glass", items: ["Vodka", "Gin", "Cream Liqueur", "Rum", "Cognac", "Cointreau"], modifiers: { 'ice': 'fa-solid fa-snowflake', 'lemon': 'fa-solid fa-lemon', 'mixer': 'fa-solid fa-blender' } }
        };

        const AIRCRAFT_CONFIGS = {
            a350: {
                premiumEconomy: {
                    rows: [16, 15, 14], // Rows from top to bottom
                    seatLayout: [
                        { seats: ['K', 'J'], aisle: true },
                        { seats: ['F', 'E', 'D'], aisle: true },
                        { seats: ['B', 'A'], aisle: false }
                    ]
                },
                economy: {
                    rows: Array.from({ length: 47 - 19 + 1 }, (_, i) => 47 - i), // Rows 47 down to 19
                    seatLayout: [
                        { seats: ['J', 'H', 'G'], aisle: true },
                        { seats: ['F', 'E', 'D'], aisle: true },
                        { seats: ['C', 'B', 'A'], aisle: false }
                    ]
                }
            },
            b777: {
                economy: {
                    rows: Array.from({ length: 50 - 17 + 1 }, (_, i) => 50 - i), // Rows 50 down to 17
                    seatLayout: [
                        { seats: ['K', 'J', 'H'], aisle: true }, // K, J, H from left to right (3 seats)
                        { seats: ['G', 'F', 'E', 'D'], aisle: true }, // G, F, E, D from left to right (4 seats)
                        { seats: ['C', 'B', 'A'], aisle: false } // C, B, A from left to right (3 seats)
                    ]
                }
            }
        };

        // --- STATE ---
        let currentAircraft = 'a350'; // Default aircraft
        let currentClass = 'premiumEconomy'; // Default class for A350
        let allOrdersCache = {
            a350: {
                premiumEconomy: {},
                economy: {}
            },
            b777: {
                economy: {}
            }
        };
        let confirmAction = null;
        let debounceTimer;

        // --- DOM ELEMENTS ---
        const cabinLayout = document.getElementById('cabin-layout').querySelector('div');
        const ordersList = document.getElementById('orders-list');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const orderModal = document.getElementById('order-modal');
        const orderModalTitle = document.getElementById('order-modal-title');
        const orderForm = document.getElementById('order-form');
        const seatIdInput = document.getElementById('seat-id-input');
        const customerNameInput = document.getElementById('customer-name-input');
        const foodSelectionContainer = document.getElementById('food-selection-container');
        const cancelBtnX = document.getElementById('cancel-btn-x');
        const deleteOrderBtn = document.getElementById('delete-order-btn');
        const drinkCategoryContainer = document.getElementById('drink-category-container');
        const drinkAccordionContainer = document.getElementById('drink-accordion-container');
        const summaryText = document.getElementById('summary-text');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const closeBtn = document.getElementById('close-btn');
        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const a350ToggleBtn = document.getElementById('a350-toggle');
        const b777ToggleBtn = document.getElementById('b777-toggle');
        const premiumEconomyToggleBtn = document.getElementById('premium-economy-toggle');
        const economyToggleBtn = document.getElementById('economy-toggle');
        const classSelectionContainer = document.getElementById('class-selection-container');

        
        // --- FUNCTIONS ---

        function setupDarkMode() {
            const darkModeMatcher = window.matchMedia('(prefers-color-scheme: dark)');
            const htmlEl = document.documentElement;
            function toggleDarkMode(isDark) {
                htmlEl.classList.toggle('dark', isDark);
            }
            toggleDarkMode(darkModeMatcher.matches);
            darkModeMatcher.addEventListener('change', e => toggleDarkMode(e.matches));
        }

        function showConfirmModal(text, action) {
            confirmModalText.textContent = text;
            confirmAction = action;
            confirmModalBackdrop.classList.remove('hidden');
            setTimeout(() => {
                confirmModalBackdrop.classList.remove('opacity-0');
                confirmModal.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function hideConfirmModal() {
            confirmModalBackdrop.classList.add('opacity-0');
            confirmModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                confirmModalBackdrop.classList.add('hidden');
                confirmAction = null;
            }, 300);
        }

        function populateMenus() {
            foodSelectionContainer.innerHTML = Object.entries(FOOD_MENU).map(([item, icon]) => `
                <button type="button" class="item-btn flex flex-col items-center justify-center p-2 border border-gray-300 dark:border-gray-600 rounded-lg w-16 h-16 sm:w-20 sm:h-20 hover:border-blue-400 dark:hover:border-blue-500" data-item="${item}">
                    <i class="${icon} text-xl sm:text-2xl text-gray-600 dark:text-gray-300"></i>
                    <span class="text-xs mt-2">${item}</span>
                </button>`).join('');

            Object.entries(DRINK_MENU).forEach(([category, details]) => {
                drinkCategoryContainer.innerHTML += `
                    <button type="button" class="category-btn p-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm flex flex-col items-center justify-center space-y-1 hover:bg-gray-100 dark:hover:bg-gray-700" data-category="${category}">
                        <i class="${details.icon} text-xl"></i><span>${category}</span>
                    </button>`;
                
                drinkAccordionContainer.innerHTML += `
                    <div id="accordion-${category.replace(/\s+/g, '-')}" class="accordion-content">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                ${details.items.map(item => `<button type="button" class="item-btn drink-item-btn border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 flex flex-col items-center justify-center text-center w-16 h-16 sm:w-20 sm:h-20" data-item="${item}"><span class="text-xs p-1">${item}</span></button>`).join('')}
                            </div>
                            <div class="modifiers-container mt-4"></div>
                        </div>
                    </div>`;
            });
        }

        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        function saveOrdersToLocalStorage() {
            try {
                localStorage.setItem('flightOrdersCache', JSON.stringify(allOrdersCache));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
            }
        }

        function loadOrdersFromLocalStorage() {
            try {
                const storedOrders = localStorage.getItem('flightOrdersCache');
                allOrdersCache = storedOrders ? JSON.parse(storedOrders) : {
                    a350: { premiumEconomy: {}, economy: {} },
                    b777: { economy: {} }
                };
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                allOrdersCache = {
                    a350: { premiumEconomy: {}, economy: {} },
                    b777: { economy: {} }
                };
            }
        }

        function autoSaveOrder() {
            const seatId = seatIdInput.value;
            if (!seatId) return;
            
            const customerName = customerNameInput.value.trim();
            const foodBtn = foodSelectionContainer.querySelector('.item-btn.selected');
            const food = foodBtn ? foodBtn.dataset.item : '';

            let drink = '';
            const selectedDrinkBtn = drinkAccordionContainer.querySelector('.drink-item-btn.selected');
            if (selectedDrinkBtn) {
                let drinkString = selectedDrinkBtn.dataset.item;
                const modifiers = [];
                const parentAccordion = selectedDrinkBtn.closest('.accordion-content');
                
                if (parentAccordion) {
                    parentAccordion.querySelectorAll('.modifier-btn.selected').forEach(btn => modifiers.push(btn.dataset.modifier));
                    const mixerBtn = parentAccordion.querySelector('.mixer-btn.selected');
                    if (mixerBtn) drinkString += ` with ${mixerBtn.dataset.item}`;
                    if (modifiers.length > 0) drinkString += ` (${modifiers.map(m => m.charAt(0).toUpperCase() + m.slice(1)).join(', ')})`;
                }
                drink = drinkString;
            }

            if (!food && !drink && !customerName) {
                delete allOrdersCache[currentAircraft][currentClass][seatId];
            } else {
                allOrdersCache[currentAircraft][currentClass][seatId] = {
                    customerName: customerName,
                    food: food,
                    drink: drink,
                    status: allOrdersCache[currentAircraft][currentClass][seatId]?.status || 'ordered',
                    updatedBy: 'Local User',
                    updatedAt: new Date().toISOString()
                };
            }
            saveOrdersToLocalStorage();
            updateUIWithOrders();
        }

        function updateModalSummary() {
            const customerName = customerNameInput.value.trim();
            const foodBtn = foodSelectionContainer.querySelector('.item-btn.selected');
            const food = foodBtn ? foodBtn.dataset.item : '';
            
            let drink = '';
            const selectedDrinkBtn = drinkAccordionContainer.querySelector('.drink-item-btn.selected');
            if (selectedDrinkBtn) {
                let drinkString = selectedDrinkBtn.dataset.item;
                const modifiers = [];
                const parentAccordion = selectedDrinkBtn.closest('.accordion-content');
                
                parentAccordion.querySelectorAll('.modifier-btn.selected').forEach(btn => modifiers.push(btn.dataset.modifier));
                const mixerBtn = parentAccordion.querySelector('.mixer-btn.selected');
                if (mixerBtn) drinkString += ` with ${mixerBtn.dataset.item}`;
                if (modifiers.length > 0) drinkString += ` (${modifiers.map(m => m.charAt(0).toUpperCase() + m.slice(1)).join(', ')})`;
                drink = drinkString;
            }

            const parts = [
                customerName ? `Name: ${customerName}` : '',
                food ? `Food: ${food}` : '',
                drink ? `Drink: ${drink}` : ''
            ].filter(Boolean);

            if (parts.length === 0) {
                summaryText.textContent = 'Make a selection...';
            } else {
                summaryText.textContent = parts.join(' | ');
            }
        }

        function createCabinLayout(aircraftType, classType) {
            const config = AIRCRAFT_CONFIGS[aircraftType][classType];
            const cabinLayoutContainer = document.getElementById('cabin-layout');
            const layoutInnerDiv = cabinLayoutContainer.querySelector('div');

            layoutInnerDiv.innerHTML = ''; // Clear existing layout

            // Use requestAnimationFrame to ensure we get an accurate clientWidth after any DOM changes
            requestAnimationFrame(() => {
                if (cabinLayoutContainer.clientWidth === 0) {
                    console.warn("Cabin layout container has no width. Retrying.");
                    setTimeout(() => createCabinLayout(aircraftType, classType), 50);
                    return;
                }

                // Ratios for spacing, relative to a seat's width
                const AISLE_RATIO = 0.5;
                const LABEL_RATIO = 0.8;
                const SEAT_GROUP_GAP_RATIO = 0.2;
                const INNER_SEAT_GAP_RATIO = 0.1;

                // Calculate total width in terms of "seat units"
                const numSeats = config.seatLayout.reduce((acc, group) => acc + group.seats.length, 0);
                const numAisles = config.seatLayout.filter(g => g.aisle).length;
                const numSeatGroups = config.seatLayout.length;
                const numLabels = 2;
                const numSeatGroupGaps = numSeatGroups > 1 ? numSeatGroups - 1 - numAisles : 0;
                const numInnerSeatGaps = config.seatLayout.reduce((acc, group) => acc + Math.max(0, group.seats.length - 1), 0);

                const totalUnits = numSeats + 
                                (numAisles * AISLE_RATIO) + 
                                (numLabels * LABEL_RATIO) + 
                                (numSeatGroupGaps * SEAT_GROUP_GAP_RATIO) + 
                                (numInnerSeatGaps * INNER_SEAT_GAP_RATIO);
                
                // Calculate pixel sizes
                const containerWidth = cabinLayoutContainer.clientWidth;
                const seatSize = Math.max(10, Math.floor(containerWidth / totalUnits)); // Min seat size of 10px
                const aisleWidth = Math.floor(seatSize * AISLE_RATIO);
                const labelWidth = Math.floor(seatSize * LABEL_RATIO);
                const seatGroupGap = Math.floor(seatSize * SEAT_GROUP_GAP_RATIO);
                const innerSeatGap = Math.floor(seatSize * INNER_SEAT_GAP_RATIO);

                const textSizeClass = seatSize > 44 ? 'text-base' : seatSize > 36 ? 'text-sm' : seatSize > 28 ? 'text-xs' : 'text-[10px]';
                const labelTextSize = Math.max(8, seatSize * 0.4);

                config.rows.forEach(rowNum => {
                    const rowEl = document.createElement('div');
                    rowEl.className = 'flex items-center justify-start w-full'; // Start from left

                    const rowLabel = (side) => {
                        const label = document.createElement('div');
                        label.className = `font-bold text-gray-500 dark:text-gray-400 text-center flex-shrink-0 flex items-center justify-center`;
                        label.style.width = `${labelWidth}px`;
                        label.style.fontSize = `${labelTextSize}px`;
                        label.textContent = rowNum;
                        return label;
                    };
                    
                    rowEl.appendChild(rowLabel('left'));

                    // Add a flexible spacer to center the content
                    const spacerLeft = document.createElement('div');
                    spacerLeft.className = 'flex-grow';
                    rowEl.appendChild(spacerLeft);

                    config.seatLayout.forEach((group, index) => {
                        const groupEl = document.createElement('div');
                        groupEl.className = 'flex';
                        groupEl.style.gap = `${innerSeatGap}px`;
                        
                        group.seats.forEach(seatLetter => {
                            const seatEl = document.createElement('div');
                            seatEl.className = `seat ${textSizeClass} font-bold bg-white dark:bg-gray-700 border-2 border-blue-500 dark:border-blue-600 rounded-md cursor-pointer hover:bg-blue-100 dark:hover:bg-gray-600`;
                            seatEl.style.width = `${seatSize}px`;
                            seatEl.style.height = `${seatSize}px`;
                            seatEl.dataset.seatId = `${rowNum}${seatLetter}`;
                            seatEl.textContent = seatLetter;
                            groupEl.appendChild(seatEl);
                        });
                        rowEl.appendChild(groupEl);

                        if (index < numSeatGroups - 1) {
                            const spacer = document.createElement('div');
                            spacer.className = 'flex-shrink-0';
                            spacer.style.width = `${group.aisle ? aisleWidth : seatGroupGap}px`;
                            rowEl.appendChild(spacer);
                        }
                    });
                    
                    const spacerRight = document.createElement('div');
                    spacerRight.className = 'flex-grow';
                    rowEl.appendChild(spacerRight);

                    rowEl.appendChild(rowLabel('right'));
                    layoutInnerDiv.appendChild(rowEl);
                });
                // After creating the layout, re-apply the order statuses
                updateUIWithOrders();
            });
        }
        
        function toggleModal(show) {
            if (show) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0');
                    orderModal.classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modalBackdrop.classList.add('opacity-0');
                orderModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                    document.title = "Flight Order Assistant";
                    autoSaveOrder(); 
                }, 300);
            }
        }

        function openOrderModal(seatId) {
            orderForm.reset();
            customerNameInput.value = '';
            foodSelectionContainer.querySelectorAll('.item-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.accordion-content').forEach(acc => acc.style.maxHeight = null);
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            drinkAccordionContainer.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
            drinkAccordionContainer.querySelectorAll('.modifiers-container').forEach(c => c.innerHTML = '');
            
            orderModalTitle.innerHTML = `Order for Seat <span class="text-blue-600 dark:text-blue-400">${seatId}</span>`;
            document.title = `Order for ${seatId}`;
            seatIdInput.value = seatId;
            
            const existingOrder = allOrdersCache[currentAircraft][currentClass][seatId];
            if (existingOrder) {
                customerNameInput.value = existingOrder.customerName || '';
                if (existingOrder.food) {
                    const foodBtn = foodSelectionContainer.querySelector(`.item-btn[data-item="${existingOrder.food}"]`);
                    if (foodBtn) foodBtn.classList.add('selected');
                }
                
                if (existingOrder.drink) {
                    let drinkName = existingOrder.drink.split('(')[0].trim();
                    let drinkParts = drinkName.split(' with ');
                    drinkName = drinkParts[0];

                    for (const [category, details] of Object.entries(DRINK_MENU)) {
                        if (details.items.includes(drinkName)) {
                            const catBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
                            if (catBtn) {
                                catBtn.classList.add('active');
                                const targetAccordion = document.getElementById(`accordion-${category.replace(/\s+/g, '-')}`);
                                targetAccordion.style.maxHeight = targetAccordion.scrollHeight + "px";
                            }
                            const drinkBtn = document.querySelector(`#accordion-${category.replace(/\s+/g, '-')} .drink-item-btn[data-item="${drinkName}"]`);
                            if (drinkBtn) {
                                drinkBtn.classList.add('selected');
                                const modifiersContainer = drinkBtn.closest('.accordion-content').querySelector('.modifiers-container');
                                
                                modifiersContainer.innerHTML = '';
                                const modifierTypes = DRINK_MENU[category].modifiers;

                                const modifierButtons = document.createElement('div');
                                modifierButtons.className = 'flex flex-wrap gap-2';
                                
                                const mixerContainer = document.createElement('div');

                                Object.entries(modifierTypes).forEach(([name, icon]) => {
                                    if (name === 'mixer') {
                                        mixerContainer.className = 'w-full mt-4';
                                        mixerContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="${icon} mr-2"></i>Mixer</h4>`;
                                        const mixerGrid = document.createElement('div');
                                        mixerGrid.className = 'grid grid-cols-3 sm:grid-cols-4 gap-2';
                                        DRINK_MENU["Soft Drinks"].items.forEach(drink => {
                                            mixerGrid.innerHTML += `<button type="button" class="item-btn mixer-btn border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 flex flex-col items-center justify-center text-center w-16 h-16 sm:w-20 sm:h-20" data-item="${drink}"><span class="text-xs p-1">${drink}</span></button>`;
                                        });
                                        mixerContainer.appendChild(mixerGrid);
                                    } else {
                                        modifierButtons.innerHTML += `
                                            <button type="button" class="modifier-btn flex flex-col items-center justify-center p-2 border border-gray-300 dark:border-gray-600 rounded-lg w-16 h-16 sm:w-20 sm:h-20 hover:border-blue-400 dark:hover:border-blue-500" data-modifier="${name}">
                                                <i class="${icon} text-xl sm:text-2xl text-gray-600 dark:text-gray-300"></i>
                                                <span class="text-xs mt-2">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                                            </button>
                                        `;
                                    }
                                });
                                modifiersContainer.appendChild(modifierButtons);
                                if(mixerContainer.innerHTML !== '') {
                                    modifiersContainer.appendChild(mixerContainer);
                                }

                                if (existingOrder.drink.includes('(') && existingOrder.drink.includes(')')) {
                                    const modifiersPart = existingOrder.drink.substring(existingOrder.drink.indexOf('(') + 1, existingOrder.drink.indexOf(')'));
                                    modifiersPart.split(',').map(m => m.trim().toLowerCase()).forEach(mod => {
                                        const modBtn = modifiersContainer.querySelector(`.modifier-btn[data-modifier="${mod}"]`);
                                        if (modBtn) modBtn.classList.add('selected');
                                    });
                                }
                                if (drinkParts.length > 1) {
                                    const mixerPart = drinkParts[1];
                                    const mixerBtn = modifiersContainer.querySelector(`.mixer-btn[data-item="${mixerPart}"]`);
                                    if (mixerBtn) mixerBtn.classList.add('selected');
                                }
                            }
                            break;
                        }
                    }
                }
            }
            
            deleteOrderBtn.classList.toggle('hidden', !existingOrder);
            updateModalSummary();
            toggleModal(true);
        }

        function updateUIWithOrders() {
            // Reset all seats to their default state first, restoring the seat letter
            document.querySelectorAll('.seat').forEach(seat => {
                seat.classList.remove('ordered', 'delivered');
                seat.classList.add('bg-white', 'dark:bg-gray-700', 'border-blue-500', 'dark:border-blue-600');
                const seatId = seat.dataset.seatId;
                const seatLetter = seatId.replace(/\d/g, ''); // Extract letter from e.g., "16K"
                seat.innerHTML = ''; // Clear any previous content (like a name div)
                seat.textContent = seatLetter; // Restore the letter
            });

            const currentClassOrders = allOrdersCache[currentAircraft][currentClass];
            const sortedOrders = Object.entries(currentClassOrders).sort(([seatA], [seatB]) => seatA.localeCompare(seatB, undefined, { numeric: true }));

            if (sortedOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No orders yet.</p>';
                clearAllBtn.disabled = true;
                return;
            }

            clearAllBtn.disabled = false;
            ordersList.innerHTML = '';

            sortedOrders.forEach(([seatId, order]) => {
                const seatEl = document.querySelector(`.seat[data-seat-id="${seatId}"]`);
                if (seatEl) {
                    // Remove default styles before adding status-specific ones
                    seatEl.classList.remove('bg-white', 'dark:bg-gray-700', 'border-blue-500', 'dark:border-blue-600');
                    seatEl.classList.add(order.status === 'delivered' ? 'delivered' : 'ordered');
                    if (order.customerName) {
                        // Display customer's full name, sized to fit horizontally
                        const seatSize = seatEl.clientWidth;
                        // Calculate a font size. Let's make it about 1/5th of the seat's width, with a minimum size.
                        const nameFontSize = Math.max(6, Math.floor(seatSize * 0.2)); 
                        seatEl.textContent = ''; // Clear seat letter
                        seatEl.innerHTML = `<div style="font-size: ${nameFontSize}px; line-height: 1.1;" class="w-full font-semibold overflow-hidden whitespace-nowrap text-center px-0.5" title="${order.customerName}">
                                                ${order.customerName}
                                            </div>`;
                    }
                }
                
                const orderItem = document.createElement('div');
                orderItem.className = 'p-3 rounded-lg border border-gray-200 dark:border-gray-700 relative flex flex-col';
                orderItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-700 dark:text-gray-200">Seat ${seatId}</h3>
                            ${order.customerName ? `<p class="text-sm font-semibold text-blue-600 dark:text-blue-400">${order.customerName}</p>` : ''}
                        </div>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <span class="text-xs font-medium px-2 py-1 rounded-full ${order.status === 'ordered' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}">
                                ${order.status === 'ordered' ? 'Ordered' : 'Delivered'}
                            </span>
                            <button data-seat-id="${seatId}" data-status="${order.status}" class="toggle-status-btn w-6 h-6 flex items-center justify-center rounded-full text-white ${order.status === 'ordered' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}" title="${order.status === 'ordered' ? 'Mark as Delivered' : 'Mark as Ordered'}">
                                <i class="fas ${order.status === 'ordered' ? 'fa-check' : 'fa-undo'} text-xs"></i>
                            </button>
                            <button data-seat-id="${seatId}" class="edit-order-btn w-6 h-6 flex items-center justify-center rounded-full bg-blue-500 text-white hover:bg-blue-600" title="Edit Order">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Food: <span class="font-medium">${order.food || 'None'}</span></p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Drink: <span class="font-medium">${order.drink || 'None'}</span></p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${new Date(order.updatedAt).toLocaleTimeString()}</p>
                `;
                ordersList.appendChild(orderItem);
            });
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            setupDarkMode();
            populateMenus();
            loadOrdersFromLocalStorage();
            
            // Initial render based on default aircraft and class
            createCabinLayout(currentAircraft, currentClass);
            updateUIWithOrders();
            updateAircraftToggleButtons();
            updateClassToggleVisibility();

            // Add resize listener to re-calculate layout
            let resizeDebounceTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeDebounceTimer);
                resizeDebounceTimer = setTimeout(() => {
                    // Re-create the layout with new dimensions and re-apply order styles
                    createCabinLayout(currentAircraft, currentClass);
                    // No need to call updateUIWithOrders here, it's called inside createCabinLayout's animation frame
                }, 200);
            });

            cabinLayout.addEventListener('click', (e) => {
                const seatEl = e.target.closest('.seat');
                if (seatEl) openOrderModal(seatEl.dataset.seatId);
            });

            cancelBtnX.addEventListener('click', () => toggleModal(false));
            closeBtn.addEventListener('click', () => toggleModal(false));

            deleteOrderBtn.addEventListener('click', () => {
                const seatId = seatIdInput.value;
                if (seatId) {
                    showConfirmModal(`Are you sure you want to delete the order for seat ${seatId}?`, () => {
                        delete allOrdersCache[currentAircraft][currentClass][seatId];
                        saveOrdersToLocalStorage();
                        updateUIWithOrders();
                        toggleModal(false);
                    });
                }
            });

            confirmActionBtn.addEventListener('click', () => {
                if (confirmAction) confirmAction();
                hideConfirmModal();
            });

            confirmCancelBtn.addEventListener('click', hideConfirmModal);

            // Debounced auto-saving for form inputs
            customerNameInput.addEventListener('input', () => {
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            });
            foodSelectionContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.item-btn');
                if (!btn) return;
                btn.classList.toggle('selected');
                if (btn.classList.contains('selected')) {
                    foodSelectionContainer.querySelectorAll('.item-btn').forEach(b => {
                        if (b !== btn) b.classList.remove('selected');
                    });
                }
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            });
            drinkCategoryContainer.addEventListener('click', handleDrinkCategoryClick);
            drinkAccordionContainer.addEventListener('click', (e) => {
                if (e.target.closest('.drink-item-btn')) handleDrinkItemClick(e);
                else if (e.target.closest('.modifier-btn')) handleModifierClick(e);
                else if (e.target.closest('.mixer-btn')) handleMixerClick(e);
            });

            clearAllBtn.addEventListener('click', () => {
                showConfirmModal("Are you sure you want to clear all orders for the current class? This cannot be undone.", () => {
                    allOrdersCache[currentAircraft][currentClass] = {}; // Clear only orders for the current class
                    saveOrdersToLocalStorage();
                    updateUIWithOrders();
                });
            });

            ordersList.addEventListener('click', (e) => {
                const toggleStatusBtn = e.target.closest('.toggle-status-btn');
                const editOrderBtn = e.target.closest('.edit-order-btn');

                if (toggleStatusBtn) {
                    const seatId = toggleStatusBtn.dataset.seatId;
                    if (allOrdersCache[currentAircraft][currentClass][seatId]) {
                        allOrdersCache[currentAircraft][currentClass][seatId].status = allOrdersCache[currentAircraft][currentClass][seatId].status === 'ordered' ? 'delivered' : 'ordered';
                        allOrdersCache[currentAircraft][currentClass][seatId].updatedBy = 'Local User';
                        allOrdersCache[currentAircraft][currentClass][seatId].updatedAt = new Date().toISOString();
                        saveOrdersToLocalStorage();
                        updateUIWithOrders();
                    }
                } else if (editOrderBtn) {
                    openOrderModal(editOrderBtn.dataset.seatId);
                }
            });

            function handleDrinkCategoryClick(e) {
                const btn = e.target.closest('.category-btn');
                if (!btn) return;
                const category = btn.dataset.category;
                const targetAccordion = document.getElementById(`accordion-${category.replace(/\s+/g, '-')}`);
                const isActive = btn.classList.contains('active');
                
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.accordion-content').forEach(acc => acc.style.maxHeight = null);
                
                if (!isActive) {
                    btn.classList.add('active');
                    targetAccordion.style.maxHeight = targetAccordion.scrollHeight + "px";
                }
            }

            function handleDrinkItemClick(e) {
                const btn = e.target.closest('.drink-item-btn');
                if (!btn) return;
                const parentAccordion = btn.closest('.accordion-content');
                const modifiersContainer = parentAccordion.querySelector('.modifiers-container');
                const category = document.querySelector('.category-btn.active').dataset.category;

                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                    modifiersContainer.innerHTML = '';
                } else {
                    parentAccordion.querySelectorAll('.drink-item-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    modifiersContainer.innerHTML = '';
                    const modifierTypes = DRINK_MENU[category].modifiers;
                    
                    const modifierButtons = document.createElement('div');
                    modifierButtons.className = 'flex flex-wrap gap-2';
                    const mixerContainer = document.createElement('div');

                    Object.entries(modifierTypes).forEach(([name, icon]) => {
                        if (name === 'mixer') {
                            mixerContainer.className = 'w-full mt-4';
                            mixerContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="${icon} mr-2"></i>Mixer</h4>`;
                            const mixerGrid = document.createElement('div');
                            mixerGrid.className = 'grid grid-cols-3 sm:grid-cols-4 gap-2';
                            DRINK_MENU["Soft Drinks"].items.forEach(drink => {
                                mixerGrid.innerHTML += `<button type="button" class="item-btn mixer-btn border border-gray-300 dark:border-gray-600 rounded-lg hover:border-blue-400 dark:hover:border-blue-500 flex flex-col items-center justify-center text-center w-16 h-16 sm:w-20 sm:h-20" data-item="${drink}"><span class="text-xs p-1">${drink}</span></button>`;
                            });
                            mixerContainer.appendChild(mixerGrid);
                        } else {
                            modifierButtons.innerHTML += `
                                <button type="button" class="modifier-btn flex flex-col items-center justify-center p-2 border border-gray-300 dark:border-gray-600 rounded-lg w-16 h-16 sm:w-20 sm:h-20 hover:border-blue-400 dark:hover:border-blue-500" data-modifier="${name}">
                                    <i class="${icon} text-xl sm:text-2xl text-gray-600 dark:text-gray-300"></i>
                                    <span class="text-xs mt-2">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                                </button>
                            `;
                        }
                    });
                    modifiersContainer.appendChild(modifierButtons);
                    if(mixerContainer.innerHTML !== '') {
                        modifiersContainer.appendChild(mixerContainer);
                    }
                }
                if (parentAccordion.style.maxHeight) parentAccordion.style.maxHeight = parentAccordion.scrollHeight + "px";
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            }

            function handleModifierClick(e) {
                e.target.closest('.modifier-btn')?.classList.toggle('selected');
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            }

            function handleMixerClick(e) {
                const btn = e.target.closest('.mixer-btn');
                if (!btn) return;
                const parentContainer = btn.closest('.grid');
                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                } else {
                    parentContainer.querySelectorAll('.mixer-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                }
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            }

            function updateAircraftToggleButtons() {
                if (currentAircraft === 'a350') {
                    a350ToggleBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                    a350ToggleBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    b777ToggleBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    b777ToggleBtn.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                } else {
                    b777ToggleBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                    b777ToggleBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    a350ToggleBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    a350ToggleBtn.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                }
            }

            function updateClassToggleButtons() {
                if (currentClass === 'premiumEconomy') {
                    premiumEconomyToggleBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                    premiumEconomyToggleBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    economyToggleBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    economyToggleBtn.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                } else {
                    economyToggleBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                    economyToggleBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    premiumEconomyToggleBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700');
                    premiumEconomyToggleBtn.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-700');
                }
            }

            function updateClassToggleVisibility() {
                if (currentAircraft === 'a350') {
                    classSelectionContainer.classList.remove('hidden');
                } else {
                    classSelectionContainer.classList.add('hidden');
                }
            }

            // Event listeners for aircraft toggles
            a350ToggleBtn.addEventListener('click', () => {
                currentAircraft = 'a350';
                currentClass = 'premiumEconomy'; // Default to premium economy for A350
                createCabinLayout(currentAircraft, currentClass);
                updateUIWithOrders();
                updateAircraftToggleButtons();
                updateClassToggleButtons(); // Update class buttons for A350
                updateClassToggleVisibility();
            });

            b777ToggleBtn.addEventListener('click', () => {
                currentAircraft = 'b777';
                currentClass = 'economy'; // Only economy for B777
                createCabinLayout(currentAircraft, currentClass);
                updateUIWithOrders();
                updateAircraftToggleButtons();
                updateClassToggleButtons(); // Update class buttons for B777
                updateClassToggleVisibility();
            });

            // Event listeners for class toggles (within A350)
            premiumEconomyToggleBtn.addEventListener('click', () => {
                currentClass = 'premiumEconomy';
                createCabinLayout(currentAircraft, currentClass);
                updateUIWithOrders();
                updateClassToggleButtons();
            });

            economyToggleBtn.addEventListener('click', () => {
                currentClass = 'economy';
                createCabinLayout(currentAircraft, currentClass);
                updateUIWithOrders();
                updateClassToggleButtons();
            });
        });
    </script>
</body>
</html>

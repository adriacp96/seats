<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Flight Order Assistant</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Flight Orders">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    <meta name="color-scheme" content="light dark">
    <link rel="apple-touch-icon" href="https://i.imghippo.com/files/HOC2025cUU.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .seat {
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        /* Dark mode styles for ordered and delivered seats */
        .seat.ordered {
            background-color: #10B981; /* Green 500 */
            color: white;
            border-color: #059669; /* Green 600 */
        }
        .dark .seat.ordered {
            background-color: #047857; /* Darker Green for dark mode */
            border-color: #065F46; /* Even darker green for dark mode border */
        }
        .seat.delivered {
            background-color: #6366F1; /* Indigo 500 */
            color: white;
            border-color: #4F46E5; /* Indigo 600 */
        }
        .dark .seat.delivered {
            background-color: #4338CA; /* Darker Indigo for dark mode */
            border-color: #3730A3; /* Even darker indigo for dark mode border */
        }
        #modal-backdrop, #confirm-modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #order-modal, #confirm-modal {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .category-btn.active {
            background-color: #3B82F6;
            color: white;
        }
        .dark .category-btn.active {
            background-color: #2563EB;
        }
        .item-btn.selected, .modifier-btn.selected, .mixer-btn.selected {
            background-color: #ECFDF5;
            border-color: #10B981;
            color: #065F46;
            font-weight: 600;
        }
        .dark .item-btn.selected, .dark .modifier-btn.selected, .dark .mixer-btn.selected {
            background-color: #064E3B;
            border-color: #34D399;
            color: #D1FAE5;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">

    <div id="app-container" class="container mx-auto p-2 sm:p-4 md:p-8 flex-1 flex flex-col">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-700 dark:text-gray-100">Flight Order Assistant</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2 text-sm sm:text-base">Select a seat to take or view an order.</p>
        </header>

        <div class="flex justify-center items-center space-x-2 sm:space-x-4 mb-6 sm:mb-8 text-xs sm:text-sm">
            <div class="flex items-center"><div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-white border-2 border-blue-500 dark:bg-gray-700"></div><span class="ml-1 sm:ml-2">Available</span></div>
            <div class="flex items-center"><div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-green-500 mr-1 sm:mr-2"></div>Ordered</div>
            <div class="flex items-center"><div class="w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-indigo-500 mr-1 sm:mr-2"></div>Delivered</div>
        </div>

        <main class="flex flex-col lg:grid lg:grid-cols-3 gap-8 flex-1">
            <div id="cabin-layout" class="lg:col-span-2 bg-white dark:bg-gray-800 p-2 sm:p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-6 text-center">Cabin Layout</h2>
                <div class="flex flex-col items-center space-y-2 sm:space-y-4">
                </div>
            </div>

            <div id="orders-summary" class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-xl shadow-lg flex flex-col h-full">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Orders Summary</h2>
                    <button id="clear-all-btn" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Clear All</button>
                </div>
                <div id="orders-list" class="space-y-3 overflow-y-auto flex-1">
                    <p class="text-gray-500 dark:text-gray-400 italic">No orders yet.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div id="order-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg flex flex-col transform scale-95 opacity-0 max-h-[85vh]">
            <div class="flex-shrink-0 p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700">
                   <h2 id="order-modal-title" class="text-2xl font-bold">Order</h2>
                   <button id="cancel-btn-x" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4 sm:p-6">
                <form id="order-form" class="space-y-6">
                    <input type="hidden" id="seat-id-input">
                    
                    <!-- Customer Name Input -->
                    <div>
                        <label for="customer-name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"><i class="fa-solid fa-user mr-2"></i>Customer Name</label>
                        <input type="text" id="customer-name-input" placeholder="Enter customer's name" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2"><i class="fa-solid fa-utensils mr-2"></i>Food</h3>
                        <div id="food-selection-container" class="flex flex-wrap gap-2">
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-3"><i class="fa-solid fa-martini-glass mr-2"></i>Drink</h3>
                        <div id="drink-category-container" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                        <div id="drink-accordion-container"></div>
                    </div >
                </form>
            </div>

            <div class="flex-shrink-0 p-4 sm:p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 rounded-b-xl">
                <div id="modal-summary" class="p-3 mb-4 bg-white dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                    <h4 class="font-semibold text-gray-700 dark:text-gray-200">Current Selection:</h4>
                    <p id="summary-text" class="text-sm text-gray-600 dark:text-gray-300 mt-1 italic">Make a selection...</p>
                </div>
                <div class="flex justify-between items-center">
                    <button type="button" id="delete-order-btn" class="text-red-600 hover:text-red-800 dark:text-red-500 dark:hover:text-red-400 font-medium">Delete Order</button>
                    <div>
                        <button type="button" id="close-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div id="confirm-modal" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transform scale-95 opacity-0">
            <h3 id="confirm-modal-title" class="text-lg font-bold">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-sm text-gray-600 dark:text-gray-400 mt-2 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button id="confirm-action-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const FOOD_MENU = {
            'Chicken': 'fa-solid fa-drumstick-bite',
            'Beef': 'fa-solid fa-cow'
        };

        const DRINK_MENU = {
            "Soft Drinks": { icon: "fa-solid fa-bottle-water", items: ["Pepsi", "Diet Pepsi", "Seven Up", "Diet Seven Up", "Tonic Water", "Sparkling Water", "Water"], modifiers: { 'ice': 'fa-solid fa-snowflake', 'lemon': 'fa-solid fa-lemon' } },
            "Hot Drinks": { icon: "fa-solid fa-mug-hot", items: ["Black Tea", "Green Tea", "Coffee"], modifiers: { 'milk': 'fa-solid fa-fill-drip', 'sugar': 'fa-solid fa-cube' } },
            "Wines": { icon: "fa-solid fa-wine-glass", items: ["Red Wine", "White Wine", "Sparkling Wine"], modifiers: {} },
            "Spirits": { icon: "fa-solid fa-whiskey-glass", items: ["Vodka", "Gin", "Cream Liqueur", "Rum", "Cognac", "Cointreau"], modifiers: { 'ice': 'fa-solid fa-snowflake', 'lemon': 'fa-solid fa-lemon', 'mixer': 'fa-solid fa-blender' } }
        };

        // --- STATE ---
        let ordersCache = {};
        let confirmAction = null;
        let debounceTimer;

        // --- DOM ELEMENTS ---
        const cabinLayout = document.getElementById('cabin-layout').querySelector('div');
        const ordersList = document.getElementById('orders-list');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const orderModal = document.getElementById('order-modal');
        const orderModalTitle = document.getElementById('order-modal-title');
        const orderForm = document.getElementById('order-form');
        const seatIdInput = document.getElementById('seat-id-input');
        const customerNameInput = document.getElementById('customer-name-input');
        const foodSelectionContainer = document.getElementById('food-selection-container');
        const cancelBtnX = document.getElementById('cancel-btn-x');
        const deleteOrderBtn = document.getElementById('delete-order-btn');
        const drinkCategoryContainer = document.getElementById('drink-category-container');
        const drinkAccordionContainer = document.getElementById('drink-accordion-container');
        const summaryText = document.getElementById('summary-text');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const closeBtn = document.getElementById('close-btn');
        const confirmModalBackdrop = document.getElementById('confirm-modal-backdrop');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        
        // --- FUNCTIONS ---

        function setupDarkMode() {
            const darkModeMatcher = window.matchMedia('(prefers-color-scheme: dark)');
            const htmlEl = document.documentElement;
            function toggleDarkMode(isDark) {
                htmlEl.classList.toggle('dark', isDark);
            }
            toggleDarkMode(darkModeMatcher.matches);
            darkModeMatcher.addEventListener('change', e => toggleDarkMode(e.matches));
        }

        function showConfirmModal(text, action) {
            confirmModalText.textContent = text;
            confirmAction = action;
            confirmModalBackdrop.classList.remove('hidden');
            setTimeout(() => {
                confirmModalBackdrop.classList.remove('opacity-0');
                confirmModal.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function hideConfirmModal() {
            confirmModalBackdrop.classList.add('opacity-0');
            confirmModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                confirmModalBackdrop.classList.add('hidden');
                confirmAction = null;
            }, 300);
        }

        function populateMenus() {
            foodSelectionContainer.innerHTML = Object.entries(FOOD_MENU).map(([item, icon]) => `
                <button type="button" class="item-btn flex flex-col items-center justify-center p-2 border border-gray-300 dark:border-gray-600 rounded-lg w-16 h-16 sm:w-20 sm:h-20 hover:border-blue-400 dark:hover:border-blue-500" data-item="${item}">
                    <i class="${icon} text-xl sm:text-2xl text-gray-600 dark:text-gray-300"></i>
                    <span class="text-xs mt-2">${item}</span>
                </button>`).join('');

            Object.entries(DRINK_MENU).forEach(([category, details]) => {
                drinkCategoryContainer.innerHTML += `
                    <button type="button" class="category-btn p-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm flex flex-col items-center justify-center space-y-1 hover:bg-gray-100 dark:hover:bg-gray-700" data-category="${category}">
                        <i class="${details.icon} text-xl"></i><span>${category}</span>
                    </button>`;
                
                drinkAccordionContainer.innerHTML += `
                    <div id="accordion-${category.replace(/\s+/g, '-')}" class="accordion-content">
                        <div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                ${details.items.map(item => `<button type="button" class="item-btn drink-item-btn p-2 border border-gray-300 dark:border-gray-600 rounded-md text-center hover:border-blue-400 dark:hover:border-blue-500" data-item="${item}">${item}</button>`).join('')}
                            </div>
                            <div class="modifiers-container mt-4"></div>
                        </div>
                    </div>`;
            });
        }

        function debounce(func, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(func, delay);
        }

        function saveOrdersToLocalStorage() {
            try {
                localStorage.setItem('flightOrders', JSON.stringify(ordersCache));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
            }
        }

        function loadOrdersFromLocalStorage() {
            try {
                const storedOrders = localStorage.getItem('flightOrders');
                ordersCache = storedOrders ? JSON.parse(storedOrders) : {};
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                ordersCache = {};
            }
        }

        function autoSaveOrder() {
            const seatId = seatIdInput.value;
            if (!seatId) return;
            
            const customerName = customerNameInput.value.trim();
            const foodBtn = foodSelectionContainer.querySelector('.item-btn.selected');
            const food = foodBtn ? foodBtn.dataset.item : '';

            let drink = '';
            const selectedDrinkBtn = drinkAccordionContainer.querySelector('.drink-item-btn.selected');
            if (selectedDrinkBtn) {
                let drinkString = selectedDrinkBtn.dataset.item;
                const modifiers = [];
                const parentAccordion = selectedDrinkBtn.closest('.accordion-content');
                
                if (parentAccordion) {
                    parentAccordion.querySelectorAll('.modifier-btn.selected').forEach(btn => modifiers.push(btn.dataset.modifier));
                    const mixerBtn = parentAccordion.querySelector('.mixer-btn.selected');
                    if (mixerBtn) drinkString += ` with ${mixerBtn.dataset.item}`;
                    if (modifiers.length > 0) drinkString += ` (${modifiers.map(m => m.charAt(0).toUpperCase() + m.slice(1)).join(', ')})`;
                }
                drink = drinkString;
            }

            if (!food && !drink && !customerName) {
                delete ordersCache[seatId];
            } else {
                ordersCache[seatId] = {
                    customerName: customerName,
                    food: food,
                    drink: drink,
                    status: ordersCache[seatId]?.status || 'ordered',
                    updatedBy: 'Local User',
                    updatedAt: new Date().toISOString()
                };
            }
            saveOrdersToLocalStorage();
            updateUIWithOrders();
        }

        function updateModalSummary() {
            const customerName = customerNameInput.value.trim();
            const foodBtn = foodSelectionContainer.querySelector('.item-btn.selected');
            const food = foodBtn ? foodBtn.dataset.item : '';
            
            let drink = '';
            const selectedDrinkBtn = drinkAccordionContainer.querySelector('.drink-item-btn.selected');
            if (selectedDrinkBtn) {
                let drinkString = selectedDrinkBtn.dataset.item;
                const modifiers = [];
                const parentAccordion = selectedDrinkBtn.closest('.accordion-content');
                
                parentAccordion.querySelectorAll('.modifier-btn.selected').forEach(btn => modifiers.push(btn.dataset.modifier));
                const mixerBtn = parentAccordion.querySelector('.mixer-btn.selected');
                if (mixerBtn) drinkString += ` with ${mixerBtn.dataset.item}`;
                if (modifiers.length > 0) drinkString += ` (${modifiers.map(m => m.charAt(0).toUpperCase() + m.slice(1)).join(', ')})`;
                drink = drinkString;
            }

            const parts = [
                customerName ? `Name: ${customerName}` : '',
                food ? `Food: ${food}` : '',
                drink ? `Drink: ${drink}` : ''
            ].filter(Boolean);

            if (parts.length === 0) {
                summaryText.textContent = 'Make a selection...';
            } else {
                summaryText.textContent = parts.join(' | ');
            }
        }

        function createCabinLayout() {
            const rows = [16, 15, 14];
            const seatConfig = [ { seats: ['K', 'J'], aisle: true }, { seats: ['F', 'E', 'D'], aisle: true }, { seats: ['B', 'A'], aisle: false } ];
            cabinLayout.innerHTML = '';
            rows.forEach(rowNum => {
                const rowEl = document.createElement('div');
                rowEl.className = 'flex items-center justify-center space-x-1 sm:space-x-2 w-full';
                
                const rowLabel = (side) => {
                    const label = document.createElement('div');
                    label.className = 'w-6 sm:w-8 font-bold text-gray-500 dark:text-gray-400 text-sm sm:text-lg';
                    label.textContent = rowNum;
                    return label;
                };
                rowEl.appendChild(rowLabel('left'));

                seatConfig.forEach(group => {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'flex space-x-1 sm:space-x-2';
                    group.seats.forEach(seatLetter => {
                        const seatEl = document.createElement('div');
                        seatEl.className = 'seat w-10 h-10 sm:w-14 sm:h-14 md:w-16 md:h-16 font-bold text-sm sm:text-lg bg-white dark:bg-gray-700 border-2 border-blue-500 dark:border-blue-600 rounded-lg cursor-pointer hover:bg-blue-100 dark:hover:bg-gray-600 flex-shrink-0';
                        seatEl.dataset.seatId = `${rowNum}${seatLetter}`;
                        seatEl.textContent = seatLetter;
                        groupEl.appendChild(seatEl);
                    });
                    rowEl.appendChild(groupEl);

                    if (group.aisle) {
                        const aisleEl = document.createElement('div');
                        aisleEl.className = 'w-2 sm:w-4 md:w-8';
                        rowEl.appendChild(aisleEl);
                    }
                });
                rowEl.appendChild(rowLabel('right'));
                cabinLayout.appendChild(rowEl);
            });
        }
        
        function toggleModal(show) {
            if (show) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0');
                    orderModal.classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modalBackdrop.classList.add('opacity-0');
                orderModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                    document.title = "Flight Order Assistant";
                    autoSaveOrder(); 
                }, 300);
            }
        }

        function openOrderModal(seatId) {
            orderForm.reset();
            customerNameInput.value = '';
            foodSelectionContainer.querySelectorAll('.item-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.accordion-content').forEach(acc => acc.style.maxHeight = null);
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            drinkAccordionContainer.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
            drinkAccordionContainer.querySelectorAll('.modifiers-container').forEach(c => c.innerHTML = '');
            
            orderModalTitle.innerHTML = `Order for Seat <span class="text-blue-600 dark:text-blue-400">${seatId}</span>`;
            document.title = `Order for ${seatId}`;
            seatIdInput.value = seatId;
            
            const existingOrder = ordersCache[seatId];
            if (existingOrder) {
                customerNameInput.value = existingOrder.customerName || '';
                if (existingOrder.food) {
                    const foodBtn = foodSelectionContainer.querySelector(`.item-btn[data-item="${existingOrder.food}"]`);
                    if (foodBtn) foodBtn.classList.add('selected');
                }
                
                if (existingOrder.drink) {
                    let drinkName = existingOrder.drink.split('(')[0].trim();
                    let drinkParts = drinkName.split(' with ');
                    drinkName = drinkParts[0];

                    for (const [category, details] of Object.entries(DRINK_MENU)) {
                        if (details.items.includes(drinkName)) {
                            const catBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
                            if (catBtn) {
                                catBtn.classList.add('active');
                                const targetAccordion = document.getElementById(`accordion-${category.replace(/\s+/g, '-')}`);
                                targetAccordion.style.maxHeight = targetAccordion.scrollHeight + "px";
                            }
                            const drinkBtn = document.querySelector(`#accordion-${category.replace(/\s+/g, '-')} .drink-item-btn[data-item="${drinkName}"]`);
                            if (drinkBtn) {
                                drinkBtn.classList.add('selected');
                                const modifiersContainer = drinkBtn.closest('.accordion-content').querySelector('.modifiers-container');
                                
                                modifiersContainer.innerHTML = '';
                                const modifierTypes = DRINK_MENU[category].modifiers;

                                const modifierButtons = document.createElement('div');
                                modifierButtons.className = 'flex flex-wrap gap-2';
                                
                                const mixerContainer = document.createElement('div');

                                Object.entries(modifierTypes).forEach(([name, icon]) => {
                                    if (name === 'mixer') {
                                        mixerContainer.className = 'w-full mt-4';
                                        mixerContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="${icon} mr-2"></i>Mixer</h4>`;
                                        const mixerGrid = document.createElement('div');
                                        mixerGrid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
                                        DRINK_MENU["Soft Drinks"].items.forEach(drink => {
                                            mixerGrid.innerHTML += `<button type="button" class="item-btn mixer-btn p-2 border border-gray-300 dark:border-gray-600 rounded-md text-center text-xs sm:text-sm hover:border-blue-400 dark:hover:border-blue-500" data-item="${drink}">${drink}</button>`;
                                        });
                                        mixerContainer.appendChild(mixerGrid);
                                    } else {
                                        modifierButtons.innerHTML += `
                                            <button type="button" class="modifier-btn flex flex-col items-center justify-center p-2 border border-gray-300 dark:border-gray-600 rounded-lg w-16 h-16 sm:w-20 sm:h-20 hover:border-blue-400 dark:hover:border-blue-500" data-modifier="${name}">
                                                <i class="${icon} text-xl sm:text-2xl text-gray-600 dark:text-gray-300"></i>
                                                <span class="text-xs mt-2">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                                            </button>
                                        `;
                                    }
                                });
                                modifiersContainer.appendChild(modifierButtons);
                                if(mixerContainer.innerHTML !== '') {
                                    modifiersContainer.appendChild(mixerContainer);
                                }

                                if (existingOrder.drink.includes('(') && existingOrder.drink.includes(')')) {
                                    const modifiersPart = existingOrder.drink.substring(existingOrder.drink.indexOf('(') + 1, existingOrder.drink.indexOf(')'));
                                    modifiersPart.split(',').map(m => m.trim().toLowerCase()).forEach(mod => {
                                        const modBtn = modifiersContainer.querySelector(`.modifier-btn[data-modifier="${mod}"]`);
                                        if (modBtn) modBtn.classList.add('selected');
                                    });
                                }
                                if (drinkParts.length > 1) {
                                    const mixerPart = drinkParts[1];
                                    const mixerBtn = modifiersContainer.querySelector(`.mixer-btn[data-item="${mixerPart}"]`);
                                    if (mixerBtn) mixerBtn.classList.add('selected');
                                }
                            }
                            break;
                        }
                    }
                }
            }
            
            deleteOrderBtn.classList.toggle('hidden', !existingOrder);
            updateModalSummary();
            toggleModal(true);
        }

        function updateUIWithOrders() {
            // Reset all seats to their default state first
            document.querySelectorAll('.seat').forEach(seat => {
                seat.classList.remove('ordered', 'delivered');
                // Ensure default background and border for available seats in dark mode
                seat.classList.add('bg-white', 'dark:bg-gray-700', 'border-blue-500', 'dark:border-blue-600');
                seat.innerHTML = `<div class="font-bold text-sm sm:text-lg">${seat.dataset.seatId.replace(/\d+/g, '')}</div>`;
            });

            const sortedOrders = Object.entries(ordersCache).sort(([seatA], [seatB]) => seatA.localeCompare(seatB, undefined, { numeric: true }));

            if (sortedOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No orders yet.</p>';
                clearAllBtn.disabled = true;
                return;
            }

            clearAllBtn.disabled = false;
            ordersList.innerHTML = '';

            sortedOrders.forEach(([seatId, order]) => {
                const seatEl = document.querySelector(`.seat[data-seat-id="${seatId}"]`);
                if (seatEl) {
                    // Remove default styles before adding status-specific ones
                    seatEl.classList.remove('bg-white', 'dark:bg-gray-700', 'border-blue-500', 'dark:border-blue-600');
                    seatEl.classList.add(order.status === 'delivered' ? 'delivered' : 'ordered');
                    if (order.customerName) {
                        // Display customer name on the seat, with smaller text and truncation to fit
                        seatEl.innerHTML = `<div class="text-[10px] leading-tight font-semibold truncate p-0.5" title="${order.customerName}">${order.customerName}</div>`;
                    }
                }
                
                const orderItem = document.createElement('div');
                orderItem.className = 'p-3 rounded-lg border border-gray-200 dark:border-gray-700 relative flex flex-col';
                orderItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-700 dark:text-gray-200">Seat ${seatId}</h3>
                            ${order.customerName ? `<p class="text-sm font-semibold text-blue-600 dark:text-blue-400">${order.customerName}</p>` : ''}
                        </div>
                        <div class="flex items-center space-x-1 flex-shrink-0">
                            <span class="text-xs font-medium px-2 py-1 rounded-full ${order.status === 'ordered' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200'}">
                                ${order.status === 'ordered' ? 'Ordered' : 'Delivered'}
                            </span>
                            <button data-seat-id="${seatId}" data-status="${order.status}" class="toggle-status-btn w-6 h-6 flex items-center justify-center rounded-full text-white ${order.status === 'ordered' ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-green-500 hover:bg-green-600'}" title="${order.status === 'ordered' ? 'Mark as Delivered' : 'Mark as Ordered'}">
                                <i class="fas ${order.status === 'ordered' ? 'fa-check' : 'fa-undo'} text-xs"></i>
                            </button>
                            <button data-seat-id="${seatId}" class="edit-order-btn w-6 h-6 flex items-center justify-center rounded-full bg-blue-500 text-white hover:bg-blue-600" title="Edit Order">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Food: <span class="font-medium">${order.food || 'None'}</span></p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Drink: <span class="font-medium">${order.drink || 'None'}</span></p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Last updated by ${order.updatedBy} at ${new Date(order.updatedAt).toLocaleTimeString()}</p>
                `;
                ordersList.appendChild(orderItem);
            });
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            setupDarkMode();
            populateMenus();
            createCabinLayout();
            loadOrdersFromLocalStorage();
            updateUIWithOrders();

            cabinLayout.addEventListener('click', (e) => {
                const seatEl = e.target.closest('.seat');
                if (seatEl) openOrderModal(seatEl.dataset.seatId);
            });

            cancelBtnX.addEventListener('click', () => toggleModal(false));
            closeBtn.addEventListener('click', () => toggleModal(false));

            deleteOrderBtn.addEventListener('click', () => {
                const seatId = seatIdInput.value;
                if (seatId) {
                    showConfirmModal(`Are you sure you want to delete the order for seat ${seatId}?`, () => {
                        delete ordersCache[seatId];
                        saveOrdersToLocalStorage();
                        updateUIWithOrders();
                        toggleModal(false);
                    });
                }
            });

            confirmActionBtn.addEventListener('click', () => {
                if (confirmAction) confirmAction();
                hideConfirmModal();
            });

            confirmCancelBtn.addEventListener('click', hideConfirmModal);

            // Debounced auto-saving for form inputs
            customerNameInput.addEventListener('input', () => {
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            });
            foodSelectionContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.item-btn');
                if (!btn) return;
                btn.classList.toggle('selected');
                if (btn.classList.contains('selected')) {
                    foodSelectionContainer.querySelectorAll('.item-btn').forEach(b => {
                        if (b !== btn) b.classList.remove('selected');
                    });
                }
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            });
            drinkCategoryContainer.addEventListener('click', handleDrinkCategoryClick);
            drinkAccordionContainer.addEventListener('click', (e) => {
                if (e.target.closest('.drink-item-btn')) handleDrinkItemClick(e);
                else if (e.target.closest('.modifier-btn')) handleModifierClick(e);
                else if (e.target.closest('.mixer-btn')) handleMixerClick(e);
            });

            clearAllBtn.addEventListener('click', () => {
                showConfirmModal("Are you sure you want to clear all orders? This cannot be undone.", () => {
                    ordersCache = {};
                    saveOrdersToLocalStorage();
                    updateUIWithOrders();
                });
            });

            ordersList.addEventListener('click', (e) => {
                const toggleStatusBtn = e.target.closest('.toggle-status-btn');
                const editOrderBtn = e.target.closest('.edit-order-btn');

                if (toggleStatusBtn) {
                    const seatId = toggleStatusBtn.dataset.seatId;
                    if (ordersCache[seatId]) {
                        ordersCache[seatId].status = ordersCache[seatId].status === 'ordered' ? 'delivered' : 'ordered';
                        ordersCache[seatId].updatedBy = 'Local User';
                        ordersCache[seatId].updatedAt = new Date().toISOString();
                        saveOrdersToLocalStorage();
                        updateUIWithOrders();
                    }
                } else if (editOrderBtn) {
                    openOrderModal(editOrderBtn.dataset.seatId);
                }
            });

            function handleDrinkCategoryClick(e) {
                const btn = e.target.closest('.category-btn');
                if (!btn) return;
                const category = btn.dataset.category;
                const targetAccordion = document.getElementById(`accordion-${category.replace(/\s+/g, '-')}`);
                const isActive = btn.classList.contains('active');
                
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.accordion-content').forEach(acc => acc.style.maxHeight = null);
                
                if (!isActive) {
                    btn.classList.add('active');
                    targetAccordion.style.maxHeight = targetAccordion.scrollHeight + "px";
                }
            }

            function handleDrinkItemClick(e) {
                const btn = e.target.closest('.drink-item-btn');
                if (!btn) return;
                const parentAccordion = btn.closest('.accordion-content');
                const modifiersContainer = parentAccordion.querySelector('.modifiers-container');
                const category = document.querySelector('.category-btn.active').dataset.category;

                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                    modifiersContainer.innerHTML = '';
                } else {
                    parentAccordion.querySelectorAll('.drink-item-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    modifiersContainer.innerHTML = '';
                    const modifierTypes = DRINK_MENU[category].modifiers;
                    
                    const modifierButtons = document.createElement('div');
                    modifierButtons.className = 'flex flex-wrap gap-2';
                    const mixerContainer = document.createElement('div');

                    Object.entries(modifierTypes).forEach(([name, icon]) => {
                        if (name === 'mixer') {
                            mixerContainer.className = 'w-full mt-4';
                            mixerContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"><i class="${icon} mr-2"></i>Mixer</h4>`;
                            const mixerGrid = document.createElement('div');
                            mixerGrid.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
                            DRINK_MENU["Soft Drinks"].items.forEach(drink => {
                                mixerGrid.innerHTML += `<button type="button" class="item-btn mixer-btn p-2 border border-gray-300 dark:border-gray-600 rounded-md text-center text-xs sm:text-sm hover:border-blue-400 dark:hover:border-blue-500" data-item="${drink}">${drink}</button>`;
                            });
                            mixerContainer.appendChild(mixerGrid);
                        } else {
                            modifierButtons.innerHTML += `
                                <button type="button" class="modifier-btn flex flex-col items-center justify-center p-2 border border-gray-300 dark:border-gray-600 rounded-lg w-16 h-16 sm:w-20 sm:h-20 hover:border-blue-400 dark:hover:border-blue-500" data-modifier="${name}">
                                    <i class="${icon} text-xl sm:text-2xl text-gray-600 dark:text-gray-300"></i>
                                    <span class="text-xs mt-2">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                                </button>
                            `;
                        }
                    });
                    modifiersContainer.appendChild(modifierButtons);
                    if(mixerContainer.innerHTML !== '') {
                        modifiersContainer.appendChild(mixerContainer);
                    }
                }
                if (parentAccordion.style.maxHeight) parentAccordion.style.maxHeight = parentAccordion.scrollHeight + "px";
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            }

            function handleModifierClick(e) {
                e.target.closest('.modifier-btn')?.classList.toggle('selected');
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            }

            function handleMixerClick(e) {
                const btn = e.target.closest('.mixer-btn');
                if (!btn) return;
                const parentContainer = btn.closest('.grid');
                if (btn.classList.contains('selected')) {
                    btn.classList.remove('selected');
                } else {
                    parentContainer.querySelectorAll('.mixer-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                }
                updateModalSummary();
                debounce(autoSaveOrder, 500);
            }

        });
    </script>
</body>
</html>

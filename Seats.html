<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Pedidos de Vuelo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .seat {
            transition: all 0.2s ease-in-out;
        }
        .seat.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }
        .seat.ordered {
            background-color: #10B981; /* green-500 */
            color: white;
            border-color: #059669; /* green-600 */
        }
        .seat.delivered {
            background-color: #6366F1; /* indigo-500 */
            color: white;
            border-color: #4F46E5; /* indigo-600 */
        }
        #modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #order-modal {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Asistente de Pedidos de Vuelo</h1>
            <p class="text-gray-500 mt-2">Selecciona un asiento para tomar o ver un pedido.</p>
            <div class="mt-4 text-sm text-gray-600">
                <p>ID de Vuelo (App): <span id="app-id-display" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
                <p class="mt-1">Tu ID de Usuario: <span id="user-id-display" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
            </div>
        </header>

        <!-- Leyenda de Colores -->
        <div class="flex justify-center items-center space-x-4 mb-8 text-sm">
            <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-white border-2 border-blue-500 mr-2"></div>Disponible</div>
            <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>Pedido</div>
            <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-indigo-500 mr-2"></div>Entregado</div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sección de la Cabina -->
            <div id="cabin-layout" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-6 text-center">Plano de la Cabina</h2>
                <div class="flex flex-col items-center space-y-4">
                    <!-- Generado por JavaScript -->
                </div>
            </div>

            <!-- Sección de Resumen de Pedidos -->
            <div id="orders-summary" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-6">Resumen de Pedidos</h2>
                <div id="orders-list" class="space-y-3 h-96 overflow-y-auto">
                    <p class="text-gray-500 italic">No hay pedidos todavía.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Pedido -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="order-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 transform scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-2">Pedido para el Asiento <span id="modal-seat-id" class="text-blue-600"></span></h2>
            <p class="text-gray-500 mb-6">Selecciona la comida y bebida o actualiza el estado del pedido.</p>
            <form id="order-form">
                <input type="hidden" id="seat-id-input">
                
                <div class="mb-4">
                    <label for="food-select" class="block text-sm font-medium text-gray-700 mb-1">Comida</label>
                    <select id="food-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Ninguna</option>
                        <option value="Pollo">Pollo</option>
                        <option value="Pasta">Pasta</option>
                        <option value="Vegetariano">Vegetariano</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="drink-select" class="block text-sm font-medium text-gray-700 mb-1">Bebida</label>
                    <select id="drink-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Ninguna</option>
                        <option value="Agua">Agua</option>
                        <option value="Zumo de Naranja">Zumo de Naranja</option>
                        <option value="Refresco">Refresco</option>
                        <option value="Café">Café</option>
                    </select>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="delete-order-btn" class="text-red-600 hover:text-red-800 font-medium">Eliminar Pedido</button>
                    <div>
                        <button type="button" id="cancel-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 mr-2">Cancelar</button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar Pedido</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-flight-456';
        
        // --- INICIALIZACIÓN DE FIREBASE ---
        let app, auth, db, userId, ordersCollectionRef;
        let isAuthReady = false;
        let ordersCache = {};

        // --- ELEMENTOS DEL DOM ---
        const cabinLayout = document.getElementById('cabin-layout').querySelector('div');
        const ordersList = document.getElementById('orders-list');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const orderModal = document.getElementById('order-modal');
        const modalSeatId = document.getElementById('modal-seat-id');
        const orderForm = document.getElementById('order-form');
        const seatIdInput = document.getElementById('seat-id-input');
        const foodSelect = document.getElementById('food-select');
        const drinkSelect = document.getElementById('drink-select');
        const cancelBtn = document.getElementById('cancel-btn');
        const deleteOrderBtn = document.getElementById('delete-order-btn');

        // --- LÓGICA DE LA APLICACIÓN ---

        /**
         * Genera el plano de la cabina basado en la configuración.
         */
        function createCabinLayout() {
            const rows = [14, 15, 16];
            const seatConfig = [
                { seats: ['A', 'B'], aisle: true },
                { seats: ['D', 'E', 'F'], aisle: true },
                { seats: ['J', 'K'], aisle: false }
            ];

            rows.forEach(rowNum => {
                const rowEl = document.createElement('div');
                rowEl.className = 'flex items-center justify-center space-x-2 w-full';

                const rowLabel = document.createElement('div');
                rowLabel.className = 'w-8 font-bold text-gray-500 text-lg';
                rowLabel.textContent = rowNum;
                rowEl.appendChild(rowLabel);

                seatConfig.forEach(group => {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'flex space-x-2';
                    group.seats.forEach(seatLetter => {
                        const seatId = `${rowNum}${seatLetter}`;
                        const seatEl = document.createElement('div');
                        seatEl.className = 'seat w-14 h-14 md:w-16 md:h-16 flex items-center justify-center font-bold text-lg bg-white border-2 border-blue-500 rounded-lg cursor-pointer hover:bg-blue-100';
                        seatEl.textContent = seatLetter;
                        seatEl.dataset.seatId = seatId;
                        groupEl.appendChild(seatEl);
                    });
                    rowEl.appendChild(groupEl);

                    if (group.aisle) {
                        const aisleEl = document.createElement('div');
                        aisleEl.className = 'w-8 md:w-12';
                        rowEl.appendChild(aisleEl);
                    }
                });
                
                const rowLabelRight = document.createElement('div');
                rowLabelRight.className = 'w-8 font-bold text-gray-500 text-lg';
                rowLabelRight.textContent = rowNum;
                rowEl.appendChild(rowLabelRight);

                cabinLayout.appendChild(rowEl);
            });
        }
        
        /**
         * Muestra u oculta el modal de pedido.
         * @param {boolean} show - True para mostrar, false para ocultar.
         */
        function toggleModal(show) {
            if (show) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0');
                    orderModal.classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modalBackdrop.classList.add('opacity-0');
                orderModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 300);
            }
        }

        /**
         * Abre el modal para un asiento específico.
         * @param {string} seatId - El ID del asiento (ej. "14A").
         */
        function openOrderModal(seatId) {
            const existingOrder = ordersCache[seatId];
            modalSeatId.textContent = seatId;
            seatIdInput.value = seatId;
            
            foodSelect.value = existingOrder?.food || '';
            drinkSelect.value = existingOrder?.drink || '';

            if (existingOrder) {
                deleteOrderBtn.classList.remove('hidden');
            } else {
                deleteOrderBtn.classList.add('hidden');
            }

            toggleModal(true);
        }

        /**
         * Actualiza la UI (asientos y lista de resumen) con los datos de los pedidos.
         */
        function updateUIWithOrders() {
            // Resetear todos los asientos
            document.querySelectorAll('.seat').forEach(seat => {
                seat.classList.remove('ordered', 'delivered');
            });

            ordersList.innerHTML = '';
            const sortedOrders = Object.values(ordersCache).sort((a, b) => a.seat.localeCompare(b.seat, undefined, { numeric: true }));

            if (sortedOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 italic">No hay pedidos todavía.</p>';
                return;
            }

            sortedOrders.forEach(order => {
                const seatEl = document.querySelector(`.seat[data-seat-id="${order.seat}"]`);
                if (seatEl) {
                    seatEl.classList.add(order.status === 'delivered' ? 'delivered' : 'ordered');
                }

                const orderItem = document.createElement('div');
                orderItem.className = 'p-3 rounded-lg border border-gray-200';
                orderItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg">${order.seat}</span>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${order.status === 'delivered' ? 'bg-indigo-100 text-indigo-800' : 'bg-green-100 text-green-800'}">
                            ${order.status === 'delivered' ? 'Entregado' : 'Pedido'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">
                        ${order.food || 'Sin comida'}, ${order.drink || 'Sin bebida'}
                    </p>
                    ${order.status !== 'delivered' ? `<button data-seat-id="${order.seat}" class="mark-delivered-btn mt-2 text-sm text-blue-600 hover:underline">Marcar como Entregado</button>` : ''}
                `;
                ordersList.appendChild(orderItem);
            });
        }

        /**
         * Maneja el envío del formulario de pedido.
         * @param {Event} e - El evento de envío del formulario.
         */
        async function handleOrderSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const seatId = seatIdInput.value;
            const food = foodSelect.value;
            const drink = drinkSelect.value;

            if (!seatId || (!food && !drink)) {
                alert("Por favor, selecciona al menos una comida o bebida.");
                return;
            }

            const orderData = {
                seat: seatId,
                food: food,
                drink: drink,
                status: ordersCache[seatId]?.status || 'ordered', // Mantener estado si ya existe
                updatedBy: userId,
                updatedAt: new Date().toISOString()
            };

            try {
                await setDoc(doc(ordersCollectionRef, seatId), orderData);
                toggleModal(false);
            } catch (error) {
                console.error("Error al guardar el pedido: ", error);
                alert("Hubo un error al guardar el pedido. Inténtalo de nuevo.");
            }
        }

        /**
         * Maneja la eliminación de un pedido.
         */
        async function handleDeleteOrder() {
            if (!isAuthReady) return;
            const seatId = seatIdInput.value;
            if (seatId && confirm(`¿Estás seguro de que quieres eliminar el pedido del asiento ${seatId}?`)) {
                try {
                    await deleteDoc(doc(ordersCollectionRef, seatId));
                    toggleModal(false);
                } catch (error) {
                    console.error("Error al eliminar el pedido: ", error);
                    alert("Hubo un error al eliminar el pedido.");
                }
            }
        }

        /**
         * Marca un pedido como entregado.
         * @param {string} seatId - El ID del asiento.
         */
        async function markAsDelivered(seatId) {
            if (!isAuthReady || !ordersCache[seatId]) return;

            const updatedOrder = { ...ordersCache[seatId], status: 'delivered' };
            try {
                await setDoc(doc(ordersCollectionRef, seatId), updatedOrder);
            } catch (error) {
                console.error("Error al marcar como entregado: ", error);
            }
        }


        // --- INICIALIZACIÓN Y EVENT LISTENERS ---
        window.onload = async () => {
            createCabinLayout();
            document.getElementById('app-id-display').textContent = appId;

            // Inicializar Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...';
                    isAuthReady = true;

                    // Referencia a la colección de pedidos
                    ordersCollectionRef = collection(db, `/artifacts/${appId}/public/data/orders`);

                    // Escuchar cambios en tiempo real
                    onSnapshot(ordersCollectionRef, (snapshot) => {
                        const newOrders = {};
                        snapshot.forEach((doc) => {
                            newOrders[doc.id] = doc.data();
                        });
                        ordersCache = newOrders;
                        updateUIWithOrders();
                    }, (error) => {
                        console.error("Error al obtener los pedidos:", error);
                    });

                } else {
                    isAuthReady = false;
                    console.log("Usuario no autenticado.");
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error de autenticación:", error);
            }

            // Event Listeners
            cabinLayout.addEventListener('click', (e) => {
                const seat = e.target.closest('.seat');
                if (seat) {
                    openOrderModal(seat.dataset.seatId);
                }
            });
            
            ordersList.addEventListener('click', (e) => {
                if (e.target.classList.contains('mark-delivered-btn')) {
                    markAsDelivered(e.target.dataset.seatId);
                }
            });

            orderForm.addEventListener('submit', handleOrderSubmit);
            cancelBtn.addEventListener('click', () => toggleModal(false));
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    toggleModal(false);
                }
            });
            deleteOrderBtn.addEventListener('click', handleDeleteOrder);
        };

    </script>
</body>
</html>

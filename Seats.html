<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Order Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .seat {
            transition: all 0.2s ease-in-out;
        }
        .seat.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }
        .seat.ordered {
            background-color: #10B981; /* green-500 */
            color: white;
            border-color: #059669; /* green-600 */
        }
        .seat.delivered {
            background-color: #6366F1; /* indigo-500 */
            color: white;
            border-color: #4F46E5; /* indigo-600 */
        }
        #modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        #order-modal {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Flight Order Assistant</h1>
            <p class="text-gray-500 mt-2">Select a seat to take or view an order.</p>
            <div class="mt-4 text-sm text-gray-600">
                <p>Flight ID (App): <span id="app-id-display" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
                <p class="mt-1">Your User ID: <span id="user-id-display" class="font-mono bg-gray-200 px-2 py-1 rounded"></span></p>
            </div>
        </header>

        <!-- Color Legend -->
        <div class="flex justify-center items-center space-x-4 mb-8 text-sm">
            <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-white border-2 border-blue-500 mr-2"></div>Available</div>
            <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>Ordered</div>
            <div class="flex items-center"><div class="w-4 h-4 rounded-full bg-indigo-500 mr-2"></div>Delivered</div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cabin Section -->
            <div id="cabin-layout" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-6 text-center">Cabin Layout</h2>
                <div class="flex flex-col items-center space-y-4">
                    <!-- Generated by JavaScript -->
                </div>
            </div>

            <!-- Orders Summary Section -->
            <div id="orders-summary" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-6">Orders Summary</h2>
                <div id="orders-list" class="space-y-3 h-96 overflow-y-auto">
                    <p class="text-gray-500 italic">No orders yet.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="order-modal" class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 transform scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-2">Order for Seat <span id="modal-seat-id" class="text-blue-600"></span></h2>
            <p class="text-gray-500 mb-6">Select the food and drink or update the order status.</p>
            <form id="order-form">
                <input type="hidden" id="seat-id-input">
                
                <div class="mb-4">
                    <label for="food-select" class="block text-sm font-medium text-gray-700 mb-1">Food</label>
                    <select id="food-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">None</option>
                        <option value="Chicken">Chicken</option>
                        <option value="Pasta">Pasta</option>
                        <option value="Vegetarian">Vegetarian</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="drink-select" class="block text-sm font-medium text-gray-700 mb-1">Drink</label>
                    <select id="drink-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">None</option>
                        <option value="Water">Water</option>
                        <option value="Orange Juice">Orange Juice</option>
                        <option value="Soda">Soda</option>
                        <option value="Coffee">Coffee</option>
                    </select>
                </div>

                <div class="flex justify-between items-center mt-8">
                    <button type="button" id="delete-order-btn" class="text-red-600 hover:text-red-800 font-medium">Delete Order</button>
                    <div>
                        <button type="button" id="cancel-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 mr-2">Cancel</button>
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Order</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-flight-456';
        
        // --- FIREBASE INITIALIZATION ---
        let app, auth, db, userId, ordersCollectionRef;
        let isAuthReady = false;
        let ordersCache = {};

        // --- DOM ELEMENTS ---
        const cabinLayout = document.getElementById('cabin-layout').querySelector('div');
        const ordersList = document.getElementById('orders-list');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const orderModal = document.getElementById('order-modal');
        const modalSeatId = document.getElementById('modal-seat-id');
        const orderForm = document.getElementById('order-form');
        const seatIdInput = document.getElementById('seat-id-input');
        const foodSelect = document.getElementById('food-select');
        const drinkSelect = document.getElementById('drink-select');
        const cancelBtn = document.getElementById('cancel-btn');
        const deleteOrderBtn = document.getElementById('delete-order-btn');

        // --- APPLICATION LOGIC ---

        /**
         * Generates the cabin layout based on the configuration.
         */
        function createCabinLayout() {
            const rows = [14, 15, 16];
            const seatConfig = [
                { seats: ['A', 'B'], aisle: true },
                { seats: ['D', 'E', 'F'], aisle: true },
                { seats: ['J', 'K'], aisle: false }
            ];

            rows.forEach(rowNum => {
                const rowEl = document.createElement('div');
                rowEl.className = 'flex items-center justify-center space-x-2 w-full';

                const rowLabel = document.createElement('div');
                rowLabel.className = 'w-8 font-bold text-gray-500 text-lg';
                rowLabel.textContent = rowNum;
                rowEl.appendChild(rowLabel);

                seatConfig.forEach(group => {
                    const groupEl = document.createElement('div');
                    groupEl.className = 'flex space-x-2';
                    group.seats.forEach(seatLetter => {
                        const seatId = `${rowNum}${seatLetter}`;
                        const seatEl = document.createElement('div');
                        seatEl.className = 'seat w-14 h-14 md:w-16 md:h-16 flex items-center justify-center font-bold text-lg bg-white border-2 border-blue-500 rounded-lg cursor-pointer hover:bg-blue-100';
                        seatEl.textContent = seatLetter;
                        seatEl.dataset.seatId = seatId;
                        groupEl.appendChild(seatEl);
                    });
                    rowEl.appendChild(groupEl);

                    if (group.aisle) {
                        const aisleEl = document.createElement('div');
                        aisleEl.className = 'w-8 md:w-12';
                        rowEl.appendChild(aisleEl);
                    }
                });
                
                const rowLabelRight = document.createElement('div');
                rowLabelRight.className = 'w-8 font-bold text-gray-500 text-lg';
                rowLabelRight.textContent = rowNum;
                rowEl.appendChild(rowLabelRight);

                cabinLayout.appendChild(rowEl);
            });
        }
        
        /**
         * Shows or hides the order modal.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleModal(show) {
            if (show) {
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0');
                    orderModal.classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modalBackdrop.classList.add('opacity-0');
                orderModal.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 300);
            }
        }

        /**
         * Opens the modal for a specific seat.
         * @param {string} seatId - The ID of the seat (e.g., "14A").
         */
        function openOrderModal(seatId) {
            const existingOrder = ordersCache[seatId];
            modalSeatId.textContent = seatId;
            seatIdInput.value = seatId;
            
            foodSelect.value = existingOrder?.food || '';
            drinkSelect.value = existingOrder?.drink || '';

            if (existingOrder) {
                deleteOrderBtn.classList.remove('hidden');
            } else {
                deleteOrderBtn.classList.add('hidden');
            }

            toggleModal(true);
        }

        /**
         * Updates the UI (seats and summary list) with order data.
         */
        function updateUIWithOrders() {
            // Reset all seats
            document.querySelectorAll('.seat').forEach(seat => {
                seat.classList.remove('ordered', 'delivered');
            });

            ordersList.innerHTML = '';
            const sortedOrders = Object.values(ordersCache).sort((a, b) => a.seat.localeCompare(b.seat, undefined, { numeric: true }));

            if (sortedOrders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 italic">No orders yet.</p>';
                return;
            }

            sortedOrders.forEach(order => {
                const seatEl = document.querySelector(`.seat[data-seat-id="${order.seat}"]`);
                if (seatEl) {
                    seatEl.classList.add(order.status === 'delivered' ? 'delivered' : 'ordered');
                }

                const orderItem = document.createElement('div');
                orderItem.className = 'p-3 rounded-lg border border-gray-200';
                orderItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg">${order.seat}</span>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${order.status === 'delivered' ? 'bg-indigo-100 text-indigo-800' : 'bg-green-100 text-green-800'}">
                            ${order.status === 'delivered' ? 'Delivered' : 'Ordered'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">
                        ${order.food || 'No food'}, ${order.drink || 'No drink'}
                    </p>
                    ${order.status !== 'delivered' ? `<button data-seat-id="${order.seat}" class="mark-delivered-btn mt-2 text-sm text-blue-600 hover:underline">Mark as Delivered</button>` : ''}
                `;
                ordersList.appendChild(orderItem);
            });
        }

        /**
         * Handles the order form submission.
         * @param {Event} e - The form submission event.
         */
        async function handleOrderSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const seatId = seatIdInput.value;
            const food = foodSelect.value;
            const drink = drinkSelect.value;

            if (!seatId || (!food && !drink)) {
                alert("Please select at least one food or drink item.");
                return;
            }

            const orderData = {
                seat: seatId,
                food: food,
                drink: drink,
                status: ordersCache[seatId]?.status || 'ordered', // Maintain status if it exists
                updatedBy: userId,
                updatedAt: new Date().toISOString()
            };

            try {
                await setDoc(doc(ordersCollectionRef, seatId), orderData);
                toggleModal(false);
            } catch (error) {
                console.error("Error saving order: ", error);
                alert("There was an error saving the order. Please try again.");
            }
        }

        /**
         * Handles deleting an order.
         */
        async function handleDeleteOrder() {
            if (!isAuthReady) return;
            const seatId = seatIdInput.value;
            if (seatId && confirm(`Are you sure you want to delete the order for seat ${seatId}?`)) {
                try {
                    await deleteDoc(doc(ordersCollectionRef, seatId));
                    toggleModal(false);
                } catch (error) {
                    console.error("Error deleting order: ", error);
                    alert("There was an error deleting the order.");
                }
            }
        }

        /**
         * Marks an order as delivered.
         * @param {string} seatId - The ID of the seat.
         */
        async function markAsDelivered(seatId) {
            if (!isAuthReady || !ordersCache[seatId]) return;

            const updatedOrder = { ...ordersCache[seatId], status: 'delivered' };
            try {
                await setDoc(doc(ordersCollectionRef, seatId), updatedOrder);
            } catch (error) {
                console.error("Error marking as delivered: ", error);
            }
        }


        // --- INITIALIZATION & EVENT LISTENERS ---
        window.onload = async () => {
            createCabinLayout();
            document.getElementById('app-id-display').textContent = appId;

            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...';
                    isAuthReady = true;

                    // Reference to the orders collection
                    ordersCollectionRef = collection(db, `/artifacts/${appId}/public/data/orders`);

                    // Listen for real-time updates
                    onSnapshot(ordersCollectionRef, (snapshot) => {
                        const newOrders = {};
                        snapshot.forEach((doc) => {
                            newOrders[doc.id] = doc.data();
                        });
                        ordersCache = newOrders;
                        updateUIWithOrders();
                    }, (error) => {
                        console.error("Error fetching orders:", error);
                    });

                } else {
                    isAuthReady = false;
                    console.log("User not authenticated.");
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error:", error);
            }

            // Event Listeners
            cabinLayout.addEventListener('click', (e) => {
                const seat = e.target.closest('.seat');
                if (seat) {
                    openOrderModal(seat.dataset.seatId);
                }
            });
            
            ordersList.addEventListener('click', (e) => {
                if (e.target.classList.contains('mark-delivered-btn')) {
                    markAsDelivered(e.target.dataset.seatId);
                }
            });

            orderForm.addEventListener('submit', handleOrderSubmit);
            cancelBtn.addEventListener('click', () => toggleModal(false));
            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) {
                    toggleModal(false);
                }
            });
            deleteOrderBtn.addEventListener('click', handleDeleteOrder);
        };

    </script>
</body>
</html>
